#!/usr/bin/bash

if [[ "$fdc_scripts_loaded" == "YES" ]]; then
    return 0;
fi


PROJECT_FOLDER="$(pwd)"

help() {
    cat - << __EOF__

New commands registered:

test       : Run unit tests
build      : build project
workoff    : Deregister all functions and deactivate virtualenvwrapper
help       : Shows this help


New variables registered:

PROJECT_FOLDER    : Current folder

__EOF__

}

test() {
  local initial_folder="$(pwd)"

  cd "$PROJECT_FOLDER"

  _modules=($(find . -regex '.*/test_.*.py' | awk '
{
  line = $0;

  line_without_find_directory_prefix = substr($line, 3);

  # print(line_without_find_directory_prefix);

  line_len = length(line_without_find_directory_prefix);

  # print(line_len);

  extension_len = length(".py");

  line_without_extension = substr(line_without_find_directory_prefix, 1, line_len - extension_len);

  # print(line_without_extension);

  module_name = line_without_extension

  gsub("/", ".", module_name);

  print(module_name);
}
'))

  IFS='
'

  # for module in "${_modules[@]}"; do
  #   echo xx "$module" yy
  # done

  python3 -m unittest "${_modules[@]}"

  cd "$initial_folder"
}

build() {
  pip3 install "$PROJECT_FOLDER"
}

workoff() {
  unset -f test
  unset -f build
  unset -f workoff
  unset -f help

  unset fdc_scripts_loaded
  unset PROJECT_FOLDER

  deactivate
}

check_dependencies() {
    local deps_nok="no"

    which virtualenvwrapper.sh &> /dev/null || (echo "'virtualenvwrapper.sh' not found..."; deps_nok="yes")
    which python3 &> /dev/null || (echo "'python3' command not found..."; deps_nok="yes")

    [[ "$deps_nok" == "no" ]] && echo "[ Dependencies ok ]"
}


check_dependencies

unset -f check_dependencies

source virtualenvwrapper.sh

export fdc_scripts_loaded="YES"

workon "$(basename $PWD)"

help
